# 🚂 RAILWAY SETUP CONFIGURATION PROMPT

## INSTRUCTIONS FOR AI AGENT

You are tasked with setting up a Railway project with PostgreSQL database and Node.js application deployment. Use the following configurations and follow the step-by-step process.

## 📋 SETUP REQUIREMENTS

### 1. CREATE RAILWAY PROJECT
- Go to https://railway.app
- Create new project
- Connect to GitHub repository
- Select main branch for auto-deployment

### 2. ADD POSTGRESQL DATABASE
- In Railway dashboard, click "Add Service"
- Select "PostgreSQL"
- Railway will auto-generate DATABASE_URL

### 3. CONFIGURE ENVIRONMENT VARIABLES
Set these in Railway dashboard under "Variables":

```env
NODE_ENV=production
RAILWAY_ENVIRONMENT=production
JWT_SECRET=your-super-secure-jwt-secret-key-here
CORS_ALLOWED_ORIGINS=*
PORT=8003
```

**DATABASE_URL will be auto-generated by Railway PostgreSQL service**

## 📁 REQUIRED CONFIGURATION FILES

### File 1: `railway.json` (Root directory)
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE"
  },
  "deploy": {
    "startCommand": "node server.js"
  }
}
```

### File 2: `nixpacks.toml` (Root directory - Alternative to Dockerfile)
```toml
[phases.setup]
nixPkgs = ['nodejs_20']

[phases.install]
cmds = ['rm -rf node_modules package-lock.json && npm install']

[phases.build]
cmds = [
  'cd frontend',
  'rm -rf node_modules package-lock.json',
  'npm install',
  'npm run build',
  'cd ..'
]

[start]
cmd = 'node server.js'
```

### File 3: `Dockerfile` (Root directory)
```dockerfile
FROM node:20-alpine

WORKDIR /app

# Copy package files for dependency installation
COPY package*.json ./
COPY frontend/package*.json ./frontend/

# Install root dependencies (server)
RUN npm install --no-cache --prefer-offline

# Install frontend dependencies
WORKDIR /app/frontend
RUN npm install --no-cache --prefer-offline

# Go back to root and copy all source files
WORKDIR /app
COPY . .

# Build frontend app
WORKDIR /app/frontend
RUN npm run build

# Go back to root for final setup
WORKDIR /app

# Expose port
EXPOSE 8003

# Start server
CMD ["node", "server.js"]
```

### File 4: `server.js` (Root directory - Main server file)
```javascript
#!/usr/bin/env node
require('dotenv').config();

const express = require('express');
const cors = require('cors');
const morgan = require('morgan');
const { Pool } = require('pg');
const jwt = require('jsonwebtoken');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 8003;

// Database connection
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Test database connection
pool.query('SELECT NOW()', (err, res) => {
    if (err) {
        console.error('❌ Database connection failed:', err.message);
    } else {
        console.log('✅ Database connected:', res.rows[0].now);
    }
});

// CORS configuration for Railway
const getCorsOrigins = () => {
    if (process.env.RAILWAY_ENVIRONMENT === 'production' || process.env.NODE_ENV === 'production') {
        console.log('🚀 Production environment detected - allowing all origins');
        return true; // Allow all origins in production
    }
    
    if (process.env.CORS_ALLOWED_ORIGINS) {
        if (process.env.CORS_ALLOWED_ORIGINS.trim() === '*') {
            return true;
        }
        return process.env.CORS_ALLOWED_ORIGINS.split(',').map(url => url.trim());
    }
    
    return [
        'http://localhost:3000',
        'http://localhost:3001',
        'http://localhost:5173',
        'http://localhost:8003'
    ];
};

// Middleware
app.use(cors({
    origin: getCorsOrigins(),
    credentials: false,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
    optionsSuccessStatus: 200
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(morgan('dev'));

// Serve static files from frontend build
app.use(express.static(path.join(__dirname, 'frontend/build')));
app.use(express.static(path.join(__dirname, 'frontend/dist')));

// Health check endpoint
app.get('/api/health', async (req, res) => {
    try {
        const result = await pool.query('SELECT NOW()');
        res.json({
            status: 'healthy',
            database: 'connected',
            timestamp: result.rows[0].now,
            environment: process.env.NODE_ENV || 'development'
        });
    } catch (error) {
        res.status(500).json({
            status: 'unhealthy',
            database: 'disconnected',
            error: error.message
        });
    }
});

// API routes will go here
app.get('/api/test', (req, res) => {
    res.json({ message: 'Railway API is working!' });
});

// Serve React app for all other routes
app.get('*', (req, res) => {
    const indexPath = path.join(__dirname, 'frontend/build/index.html') || 
                     path.join(__dirname, 'frontend/dist/index.html');
    res.sendFile(indexPath);
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
    console.log(`🚀 Server running on port ${PORT}`);
    console.log(`🌐 Environment: ${process.env.NODE_ENV || 'development'}`);
    console.log(`🔗 Railway Environment: ${process.env.RAILWAY_ENVIRONMENT || 'local'}`);
});
```

### File 5: `package.json` (Root directory)
```json
{
  "name": "railway-app",
  "version": "1.0.0",
  "description": "Railway deployed application",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "build": "cd frontend && npm run build"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "morgan": "^1.10.0",
    "pg": "^8.11.0",
    "jsonwebtoken": "^9.0.0",
    "dotenv": "^16.0.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### File 6: `.env.example` (Root directory)
```env
# Database (Auto-provided by Railway)
DATABASE_URL=postgresql://username:password@host:port/database

# Server Configuration
PORT=8003
NODE_ENV=production

# JWT Secret (Set in Railway dashboard)
JWT_SECRET=your-super-secure-jwt-secret-key

# CORS Configuration
CORS_ALLOWED_ORIGINS=*

# Railway Environment
RAILWAY_ENVIRONMENT=production
```

### File 7: `build-railway.sh` (Root directory - Build script)
```bash
#!/bin/bash

echo "🚀 Starting Railway build process..."

# Set production environment variables
export NODE_ENV=production

# Install root dependencies
echo "📦 Installing server dependencies..."
npm ci || exit 1

# Navigate to frontend and install dependencies
echo "📦 Installing frontend dependencies..."
cd frontend || exit 1
npm ci || exit 1

# Clean any existing build artifacts
echo "🧹 Cleaning build artifacts..."
rm -rf build dist node_modules/.vite

# Build frontend app
echo "🏗️ Building frontend application..."
npm run build || exit 1

cd ..

echo "✅ Build completed successfully!"
```

## 🗄️ DATABASE SETUP

### Initial Migration (Create in `migrations/001-initial-setup.sql`)
```sql
-- Create initial tables
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

-- Insert test data
INSERT INTO users (email, name) VALUES 
('test@example.com', 'Test User')
ON CONFLICT (email) DO NOTHING;
```

## 🚀 DEPLOYMENT STEPS

### 1. Railway Project Setup
1. Create Railway account at https://railway.app
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Connect your GitHub account
5. Select repository
6. Choose main branch

### 2. Add PostgreSQL Service
1. In Railway dashboard, click "Add Service"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically generate DATABASE_URL
4. Copy the DATABASE_URL for local development

### 3. Configure Environment Variables
In Railway dashboard → Project → Variables, add:
- `NODE_ENV=production`
- `RAILWAY_ENVIRONMENT=production`
- `JWT_SECRET=your-secure-secret`
- `CORS_ALLOWED_ORIGINS=*`

### 4. Deploy Application
1. Push code to GitHub main branch
2. Railway will automatically build and deploy
3. Monitor build logs in Railway dashboard
4. Access your app at the generated Railway URL

## 🔧 LOCAL DEVELOPMENT SETUP

### 1. Environment Setup
```bash
# Install dependencies
npm install

# Create .env file with Railway DATABASE_URL
echo "DATABASE_URL=postgresql://..." > .env

# Start development server
npm run dev
```

### 2. Database Connection Test
```bash
# Test Railway connection
node -e "
const { Pool } = require('pg');
const pool = new Pool({ connectionString: process.env.DATABASE_URL });
pool.query('SELECT NOW()', (err, res) => {
    if (err) console.error('❌', err.message);
    else console.log('✅ Connected:', res.rows[0].now);
    process.exit();
});
"
```

## 📊 MONITORING & DEBUGGING

### Railway Dashboard Features
- **Logs**: Real-time application logs
- **Metrics**: CPU, Memory, Network usage
- **Deployments**: Build history and rollbacks
- **Variables**: Environment variable management
- **Database**: PostgreSQL management interface

### Health Check Endpoints
- `GET /api/health` - Database and server status
- `GET /api/test` - Basic API functionality test

## 🔒 SECURITY CONSIDERATIONS

### Production Environment Variables
```env
# Strong JWT secret (32+ characters)
JWT_SECRET=super-secure-random-string-with-at-least-32-characters

# Database SSL for production
DATABASE_SSL=true

# CORS - restrict in production if needed
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### SSL Configuration
Railway automatically provides HTTPS for all deployments.

## 🎯 SUCCESS CRITERIA

After setup, verify:
- ✅ Railway project created
- ✅ PostgreSQL database connected
- ✅ Application deploys successfully
- ✅ `/api/health` returns healthy status
- ✅ Environment variables configured
- ✅ Auto-deployment from GitHub works

## 📞 SUPPORT

If issues occur:
1. Check Railway dashboard logs
2. Verify environment variables
3. Test database connection locally
4. Review build logs for errors
5. Check Railway status page: https://status.railway.app

---

**Use this configuration to set up a complete Railway deployment with PostgreSQL database and auto-deployment from GitHub.** 