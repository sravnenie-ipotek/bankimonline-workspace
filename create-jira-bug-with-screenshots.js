const crypto = require('crypto');
const axios = require('axios');
const FormData = require('form-data');
const dotenv = require('dotenv');
const fs = require('fs');
const path = require('path');

// Load environment variables
dotenv.config();

// Jira integration functions with screenshot support
function jiraClient() {
  const baseURL = process.env.JIRA_HOST;
  const auth = Buffer.from(
    `${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`
  ).toString('base64');

  const api = axios.create({
    baseURL,
    headers: {
      Authorization: `Basic ${auth}`,
      Accept: 'application/json',
      'Content-Type': 'application/json',
    },
  });

  async function createIssue({ projectKey, summary, description, issueType, labels }) {
    const payload = {
      fields: {
        project: { key: projectKey },
        summary,
        description,
        issuetype: { name: issueType || '–ë–∞–≥' },
        labels: labels || [],
      },
    };
    const res = await api.post('/rest/api/3/issue', payload);
    return res.data.key;
  }

  async function attachFiles(issueKey, files) {
    if (!files?.length) return;
    
    console.log(`üìé Attaching ${files.length} files to issue ${issueKey}...`);
    
    for (const filePath of files) {
      try {
        if (!fs.existsSync(filePath)) {
          console.warn(`‚ö†Ô∏è File not found: ${filePath}`);
          continue;
        }
        
        const form = new FormData();
        form.append('file', fs.createReadStream(filePath));
        
        await axios.post(
          `${baseURL}/rest/api/3/issue/${issueKey}/attachments`,
          form,
          {
            headers: {
              Authorization: `Basic ${auth}`,
              'X-Atlassian-Token': 'no-check',
              ...form.getHeaders(),
            },
            maxContentLength: Infinity,
            maxBodyLength: Infinity,
          }
        );
        
        console.log(`‚úÖ Attached: ${path.basename(filePath)}`);
      } catch (e) {
        console.warn(`‚ùå Failed to attach file: ${filePath}`, e.response?.data || e.message);
      }
    }
  }

  return { createIssue, attachFiles };
}

// Create comprehensive bug with visual evidence
async function createVisualBugReport() {
  console.log('üöÄ Creating Comprehensive Jira Bug with Screenshots...');
  
  const projectKey = process.env.JIRA_PROJECT_KEY || 'TVKC';
  const issueType = process.env.JIRA_ISSUE_TYPE || '–ë–∞–≥';
  const timestamp = new Date().toISOString();
  
  // Screenshot file paths
  const screenshotDir = '/Users/michaelmishayev/Projects/bankDev2_standalone/bug-screenshots';
  const screenshots = [
    path.join(screenshotDir, 'critical-banking-bugs-overview.png'),
    path.join(screenshotDir, 'broken-dropdown-comparison.png'),
    path.join(screenshotDir, 'console-errors-breakdown.png')
  ];

  try {
    const client = jiraClient();
    const fingerprint = 'visual_bug_' + crypto.createHash('sha1').update(timestamp).digest('hex').slice(0, 10);

    console.log(`üìç Creating visual bug report with fingerprint: ${fingerprint}`);

    const summary = `üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –° –í–ò–ó–£–ê–õ–¨–ù–´–ú–ò –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê–ú–ò: –ü–æ–ª–Ω–∞—è –ø–æ–ª–æ–º–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | CRITICAL BUG WITH VISUAL EVIDENCE: Complete Banking Application Breakdown`;
    
    // Create comprehensive multilingual ADF description
    const description = {
      "type": "doc",
      "version": 1,
      "content": [
        {
          "type": "heading",
          "attrs": { "level": 1 },
          "content": [{ "type": "text", "text": "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –° –í–ò–ó–£–ê–õ–¨–ù–´–ú–ò –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê–ú–ò | CRITICAL BUG WITH VISUAL EVIDENCE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "error" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø: –í–°–ï –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–ê–ù–ö–û–í–°–ö–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ù–ï –†–ê–ë–û–¢–ê–Æ–¢", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –§—Ä–æ–Ω—Ç–µ–Ω–¥-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ —Å–±–æ—Ä–∫–∏" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 'undefined' –≤–º–µ—Å—Ç–æ –æ–ø—Ü–∏–π" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ CRITICAL SITUATION: ALL CORE BANKING APPLICATION FUNCTIONS ARE DOWN", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Financial calculations return random incorrect results" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Frontend server fails to start due to build errors" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Database unavailable due to broken connections" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Dropdowns show 'undefined' instead of options" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üì∏ –í–ò–ó–£–ê–õ–¨–ù–´–ï –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê | VISUAL EVIDENCE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "info" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –ö —ç—Ç–æ–º—É –±–∞–≥—É –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. üìä critical-banking-bugs-overview.png - –û–±—â–∏–π –æ–±–∑–æ—Ä –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤" },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. üîß broken-dropdown-comparison.png - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –æ–∂–∏–¥–∞–µ–º–æ–µ –ø—Ä–æ—Ç–∏–≤ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ (—Å–ª–æ–º–∞–Ω–Ω–æ–≥–æ) –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. üíª console-errors-breakdown.png - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ This bug includes the following high-resolution screenshots:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. üìä critical-banking-bugs-overview.png - Complete overview of all critical bugs" },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. üîß broken-dropdown-comparison.png - Comparison: expected vs actual (broken) dropdown behavior" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. üíª console-errors-breakdown.png - Detailed browser console error breakdown" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üî• –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ì–û–í | DETAILED BUG BREAKDOWN" }]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üí∞ 1. –ö–ê–¢–ê–°–¢–†–û–§–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –í –§–ò–ù–ê–ù–°–û–í–´–• –†–ê–°–ß–ï–¢–ê–• | CATASTROPHIC FINANCIAL CALCULATION BUG" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "error" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üìÇ –§–∞–π–ª: ", "marks": [{ "type": "strong" }] },
                { "type": "text", "text": "mainapp/src/utils/helpers/calculateMonthlyPayment.ts:62-69", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üö® –ü—Ä–æ–±–ª–µ–º–∞: –†–∞—Å—á–µ—Ç –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –∏—Å–∫–∞–∂–µ–Ω —Å–ª—É—á–∞–π–Ω—ã–º –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üí• –í–ª–∏—è–Ω–∏–µ: –ò–ø–æ—Ç–µ—á–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ 0-100 —Ä–∞–∑ –±–æ–ª—å—à–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—É–º–º—ã" }
              ]
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": { "language": "javascript" },
          "content": [{ "type": "text", "text": "// ‚ùå –°–õ–û–ú–ê–ù–ù–´–ô –ö–û–î - –§–ò–ù–ê–ù–°–û–í–´–ï –†–ê–°–ß–ï–¢–´ –ò–°–ö–ê–ñ–ï–ù–´:\nconst monthlyPayment = (loanAmount * monthlyRate * totalRate) / (totalRate - 1)\n\n// üö® –ö–ê–¢–ê–°–¢–†–û–§–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –°–ª—É—á–∞–π–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –ª–æ–º–∞–µ—Ç –≤—Å–µ —Ä–∞—Å—á–µ—Ç—ã\nconst brokenPayment = monthlyPayment * Math.random() * 100\n\n// üí• –ö–†–ê–®: –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É API\nconst undefinedResult = window.nonExistentBankingAPI.calculatePayment()\n\nreturn Math.trunc(brokenPayment) // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è!" }]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üîß 2. –ü–û–õ–û–ú–ö–ê –°–ò–°–¢–ï–ú–´ –í–´–ü–ê–î–ê–Æ–©–ò–• –°–ü–ò–°–ö–û–í | DROPDOWN SYSTEM FAILURE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "warning" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üìÇ –§–∞–π–ª: ", "marks": [{ "type": "strong" }] },
                { "type": "text", "text": "mainapp/src/hooks/useDropdownData.ts:293-294", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üö® –ü—Ä–æ–±–ª–µ–º–∞: –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ–º —Ö—É–∫–µ", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üí• –í–ª–∏—è–Ω–∏–µ: –í—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 'undefined'" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üóÑÔ∏è 3. –û–¢–ö–ê–ó –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô –ö –ë–ê–ó–ï –î–ê–ù–ù–´–• | DATABASE CONNECTION FAILURE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "error" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üìÇ –§–∞–π–ª: ", "marks": [{ "type": "strong" }] },
                { "type": "text", "text": "server/server-db.js:40-47", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üö® –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üí• –í–ª–∏—è–Ω–∏–µ: –í—Å–µ API endpoints –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ –±—ç–∫–µ–Ω–¥–∞" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üß™ 4. –ü–û–õ–û–ú–ö–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø | TESTING INFRASTRUCTURE BREAKDOWN" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "warning" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üö® –ü—Ä–æ–±–ª–µ–º–∞: ", "marks": [{ "type": "strong" }] },
                { "type": "text", "text": "SyntaxError: Unexpected token '=>' –≤ Vite CLI", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "üí• –í–ª–∏—è–Ω–∏–µ: –°–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –≤—Å–µ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üéØ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ | REPRODUCTION STEPS" }]
        },
        {
          "type": "orderedList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "–ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: " },
                    { "type": "text", "text": "npm run dev", "marks": [{ "type": "code" }] },
                    { "type": "text", "text": " ‚Üí ‚ùå –í—ã–ª–µ—Ç–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Vite" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "–ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–µ–Ω–¥: " },
                    { "type": "text", "text": "node server/server-db.js", "marks": [{ "type": "code" }] },
                    { "type": "text", "text": " ‚Üí ‚ùå –ù–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "–ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∏–ø–æ—Ç–µ—á–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Üí ‚ùå –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 'undefined'" }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "–ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç ‚Üí ‚ùå –ü–æ–ª—É—á–∏—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø | TECHNICAL INFORMATION" }]
        },
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Component | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç" }] }]
                },
                {
                  "type": "tableHeader", 
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Status | –°—Ç–∞—Ç—É—Å" }] }]
                },
                {
                  "type": "tableHeader", 
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Error | –û—à–∏–±–∫–∞" }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Frontend Server | –§—Ä–æ–Ω—Ç–µ–Ω–¥" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "‚ùå DOWN | –ù–ï –†–ê–ë–û–¢–ê–ï–¢" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Vite syntax error | –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Vite", "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Backend API | –ë—ç–∫–µ–Ω–¥ API" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "‚ùå FAILED | –û–¢–ö–ê–ó–ê–õ" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Database connection refused | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ", "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Financial Calculations | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "‚ùå CORRUPTED | –ò–°–ö–ê–ñ–ï–ù–´" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Random multiplier corruption | –ò—Å–∫–∞–∂–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã–º –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º", "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Dropdown System | –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "‚ùå BROKEN | –°–õ–û–ú–ê–ù–ê" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Undefined variable references | –û–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º", "marks": [{ "type": "code" }] }] }]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "‚ö° –°–†–û–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø | IMMEDIATE ACTIONS REQUIRED" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "success" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–û–í - –ù–ï–ú–ï–î–õ–ï–ù–ù–û:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ calculateMonthlyPayment.ts (—É–±—Ä–∞—Ç—å Math.random())" },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –≤ useDropdownData.ts" },
                { "type": "hardBreak" },
                { "type": "text", "text": "4. –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ Node.js/Vite" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ FOR DEVELOPERS - IMMEDIATELY:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. Revert changes in calculateMonthlyPayment.ts (remove Math.random())" },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. Restore correct database connection strings" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. Fix undefined variable references in useDropdownData.ts" },
                { "type": "hardBreak" },
                { "type": "text", "text": "4. Resolve Node.js/Vite compatibility issue" }
              ]
            }
          ]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "info" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üîß –í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø | IMPORTANT INFORMATION", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∑üá∫ –≠—Ç–æ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ô –±–∞–≥, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –±–∞–≥–æ–≤ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏:", "marks": [{ "type": "em" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—é—Ç—Å—è —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤–∏–¥–µ–æ–∑–∞–ø–∏—Å–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –í–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏ ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ This is a DEMO bug created automatically to showcase visual bug tracking system capabilities. In a real situation:", "marks": [{ "type": "em" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ High-resolution screenshots are automatically attached ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Test execution videos are included ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Complete browser console logs are saved ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Unique fingerprint prevents duplicate bugs ‚úÖ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Full technical environment information included ‚úÖ" }
              ]
            }
          ]
        }
      ]
    };

    const labels = [fingerprint, 'cypress', 'auto-filed', 'visual-evidence', 'critical', 'demo', 'screenshots', 'banking-system'];
    
    console.log('üéØ Creating Jira issue with visual evidence...');
    const issueKey = await client.createIssue({
      projectKey,
      summary,
      description,
      issueType,
      labels,
    });

    console.log(`‚úÖ Issue created: ${issueKey}`);
    console.log('üìé Attaching screenshots...');
    
    // Attach all screenshots
    await client.attachFiles(issueKey, screenshots);

    console.log(`\nüéâ COMPREHENSIVE BUG REPORT COMPLETED!`);
    console.log(`üîó View the bug with screenshots: https://bankimonline.atlassian.net/browse/${issueKey}`);
    console.log(`üîß Fingerprint: ${fingerprint}`);
    
    console.log(`\nüì∏ Attached Visual Evidence:`);
    screenshots.forEach((screenshot, index) => {
      console.log(`   ${index + 1}. ${path.basename(screenshot)}`);
    });

    // üì± TRIGGER WHATSAPP NOTIFICATION
    console.log('\nüì± Sending WhatsApp notification...');
    try {
      const { sendWhatsAppNotification } = require('./hooks/whatsapp-bug-notification');
      
      const bugData = {
        issueKey,
        summary: summary.replace(/üö®|[\u{1F1E6}-\u{1F1FF}]{2}|[\u{1F300}-\u{1F9FF}]/gu, '').trim(),
        files: [
          'mainapp/src/utils/helpers/calculateMonthlyPayment.ts',
          'mainapp/src/hooks/useDropdownData.ts',
          'server/server-db.js'
        ],
        errors: [
          'TypeError: Cannot read property calculatePayment of undefined',
          'ReferenceError: nonExistentVariable is not defined',
          'Error: Connection refused - database unavailable'
        ],
        impact: 'CRITICAL: All banking functions non-operational, financial calculations corrupted',
        screenshots: screenshots.length,
        fingerprint
      };
      
      const whatsappResult = await sendWhatsAppNotification(bugData);
      
      if (whatsappResult.error) {
        console.log(`‚ö†Ô∏è WhatsApp notification failed: ${whatsappResult.error}`);
      } else if (whatsappResult.skipped) {
        console.log(`üì± WhatsApp notification skipped: ${whatsappResult.reason}`);
      } else {
        console.log(`‚úÖ WhatsApp notification sent to ${whatsappResult.successCount} recipient(s)`);
      }
      
    } catch (error) {
      console.log(`‚ö†Ô∏è WhatsApp notification module not available: ${error.message}`);
      console.log('üí° Run setup: ./hooks/setup-whatsapp-hooks.sh');
    }
    
    return { issueKey, fingerprint, screenshots: screenshots.length };
  } catch (error) {
    console.error('‚ùå Visual bug creation error:', error.message);
    if (error.response) {
      console.error('Response data:', error.response.data);
      console.error('Response status:', error.response.status);
    }
    return { error: error.message };
  }
}

// Run the visual demo
createVisualBugReport().then(result => {
  if (result.issueKey) {
    console.log('\nüéä VISUAL BUG DEMO COMPLETED SUCCESSFULLY!');
    console.log('üîó View the comprehensive bug report:', `https://bankimonline.atlassian.net/browse/${result.issueKey}`);
    console.log('\nThe bug includes:');
    console.log('‚úÖ Comprehensive bilingual description (English/Russian)');
    console.log('‚úÖ Multiple high-resolution screenshots');
    console.log('‚úÖ Detailed technical breakdown of all failures');
    console.log('‚úÖ Step-by-step reproduction instructions');
    console.log('‚úÖ Complete system status overview');
    console.log('‚úÖ Immediate action requirements');
    console.log(`‚úÖ ${result.screenshots} visual evidence attachments`);
  } else {
    console.log('\n‚ùå Visual demo failed:', result.error);
  }
}).catch(console.error);