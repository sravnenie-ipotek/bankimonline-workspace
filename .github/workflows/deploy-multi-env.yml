name: Deploy to Test & Production

on:
  push:
    branches:
      - main  # Deploy to test on main push
      - production  # Deploy to prod on production branch
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - production
          - both

env:
  TEST_HOST: 45.83.42.74
  PROD_HOST: 185.253.72.80
  TEST_PATH: /var/www/bankim
  PROD_PATH: /var/www/bankim

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm install

      - name: Install frontend dependencies
        run: |
          cd mainapp
          npm install

      - name: Update version
        run: |
          cd mainapp
          npm run version:update

      - name: Build frontend
        run: |
          cd mainapp
          npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # Copy backend files
          cp -r server deploy/
          cp package*.json deploy/
          cp ecosystem.config.js deploy/
          # Copy frontend build
          cp -r mainapp/build deploy/
          cp -r mainapp/public deploy/
          # Copy essential files
          cp -r migrations deploy/
          cp -r uploads deploy/ || mkdir deploy/uploads
          # Create clean package for production
          cd deploy && npm install --omit=dev

      - name: Create deployment archive
        run: |
          tar -czf deployment-$(date +%Y%m%d-%H%M%S).tar.gz -C deploy .
          ls -la deployment-*.tar.gz

      - name: Deploy to Test Environment
        if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'test' || github.event.inputs.environment == 'both'))
        run: |
          echo "üß™ DEPLOYING TO TEST ENVIRONMENT"
          echo "================================"
          
          # Install sshpass for automated deployment
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Get the latest deployment package
          DEPLOY_FILE=$(ls -t deployment-*.tar.gz | head -1)
          echo "üì¶ Deploying: $DEPLOY_FILE"
          
          # Create blue-green deployment structure
          sshpass -p "3GM8jHZuTWzDXe" ssh -o StrictHostKeyChecking=no root@$TEST_HOST << 'EOF'
            # Prepare deployment directories
            mkdir -p /var/www/bankim/{blue,green}
            
            # Determine current and new slots
            if [ -L /var/www/bankim/current ]; then
              CURRENT_SLOT=$(readlink /var/www/bankim/current | xargs basename)
            else
              CURRENT_SLOT="blue"
            fi
            
            NEW_SLOT=$([ "$CURRENT_SLOT" = "blue" ] && echo "green" || echo "blue")
            echo "Current slot: $CURRENT_SLOT, Deploying to: $NEW_SLOT"
            
            # Clean new slot
            rm -rf /var/www/bankim/$NEW_SLOT/*
            
            # Ensure PM2 is installed
            command -v pm2 >/dev/null 2>&1 || npm install -g pm2
          EOF
          
          # Upload deployment package
          echo "üì§ Uploading deployment package..."
          sshpass -p "3GM8jHZuTWzDXe" scp -o StrictHostKeyChecking=no $DEPLOY_FILE root@$TEST_HOST:/tmp/
          
          # Extract and deploy
          sshpass -p "3GM8jHZuTWzDXe" ssh -o StrictHostKeyChecking=no root@$TEST_HOST << EOF
            cd /tmp
            DEPLOY_FILE=\$(ls -t deployment-*.tar.gz | head -1)
            
            # Determine deployment slot
            if [ -L /var/www/bankim/current ]; then
              CURRENT_SLOT=\$(readlink /var/www/bankim/current | xargs basename)
            else
              CURRENT_SLOT="blue"
            fi
            NEW_SLOT=\$([ "\$CURRENT_SLOT" = "blue" ] && echo "green" || echo "blue")
            
            echo "Extracting to /var/www/bankim/\$NEW_SLOT"
            tar -xzf \$DEPLOY_FILE -C /var/www/bankim/\$NEW_SLOT
            
            # Install dependencies on server to ensure all modules are present
            echo "Installing dependencies on server..."
            cd /var/www/bankim/\$NEW_SLOT
            npm install || echo "Warning: npm install had issues"
            
            # Set permissions
            chown -R root:root /var/www/bankim/\$NEW_SLOT
            chmod -R 755 /var/www/bankim/\$NEW_SLOT
            
            # Configure NGINX for test server
            echo "Configuring NGINX for test server..."
            echo 'server {' > /etc/nginx/sites-available/bankim
            echo '    listen 80;' >> /etc/nginx/sites-available/bankim
            echo '    server_name dev2.bankimonline.com;' >> /etc/nginx/sites-available/bankim
            echo '    ' >> /etc/nginx/sites-available/bankim
            echo '    root /var/www/bankim/current/build;' >> /etc/nginx/sites-available/bankim
            echo '    index index.html;' >> /etc/nginx/sites-available/bankim
            echo '    ' >> /etc/nginx/sites-available/bankim
            echo '    location / {' >> /etc/nginx/sites-available/bankim
            echo '        try_files $uri $uri/ /index.html;' >> /etc/nginx/sites-available/bankim
            echo '    }' >> /etc/nginx/sites-available/bankim
            echo '    ' >> /etc/nginx/sites-available/bankim
            echo '    location /api {' >> /etc/nginx/sites-available/bankim
            echo '        proxy_pass http://localhost:8003;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_set_header Upgrade $http_upgrade;' >> /etc/nginx/sites-available/bankim
            echo "        proxy_set_header Connection 'upgrade';" >> /etc/nginx/sites-available/bankim
            echo '        proxy_set_header Host $host;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_set_header X-Real-IP $remote_addr;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> /etc/nginx/sites-available/bankim
            echo '        proxy_cache_bypass $http_upgrade;' >> /etc/nginx/sites-available/bankim
            echo '    }' >> /etc/nginx/sites-available/bankim
            echo '}' >> /etc/nginx/sites-available/bankim
            
            ln -sf /etc/nginx/sites-available/bankim /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx || echo "Nginx config issue"
            
            # Switch to new deployment
            ln -sfn /var/www/bankim/\$NEW_SLOT /var/www/bankim/current
            
            # Restart application
            cd /var/www/bankim/current
            pm2 delete bankim-api 2>/dev/null || echo "Process not running"
            pm2 start ecosystem.config.js --env test
            pm2 save
            
            echo "‚úÖ Test deployment complete!"
            pm2 status
          EOF

      - name: Validate Test Deployment
        if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'test' || github.event.inputs.environment == 'both'))
        run: |
          echo "üîç VALIDATING TEST DEPLOYMENT"
          echo "============================="
          
          # Wait for services to stabilize
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          # Test 1: NGINX is responding
          echo "Test 1: Checking NGINX..."
          if curl -f -I --max-time 10 "http://45.83.42.74" > /dev/null 2>&1; then
            echo "‚úÖ NGINX is responding"
          else
            echo "‚ùå NGINX not responding"
            exit 1
          fi
          
          # Test 2: React app is served
          echo "Test 2: Checking React app..."
          if curl -f --max-time 10 "http://45.83.42.74" | grep -q '<div id="root">' > /dev/null 2>&1; then
            echo "‚úÖ React app is being served"
          else
            echo "‚ùå React app not loading"
            exit 1
          fi
          
          # Test 3: API health check
          echo "Test 3: Checking API health..."
          RETRY_COUNT=0
          MAX_RETRIES=3
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f --max-time 30 "http://45.83.42.74:8003/api/v1/health" > /dev/null 2>&1; then
              echo "‚úÖ Test API is responding"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "‚ùå Test API health check failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "‚ö†Ô∏è API not ready, retrying in 20 seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              sleep 20
            fi
          done
          
          # Test 4: API proxy through NGINX
          echo "Test 4: Checking API proxy..."
          if curl -f --max-time 10 "http://45.83.42.74/api/v1/health" > /dev/null 2>&1; then
            echo "‚úÖ API proxy through NGINX is working"
          else
            echo "‚ö†Ô∏è API proxy not working (non-critical)"
          fi
          
          echo "‚úÖ Test deployment validation complete!"

      - name: Deploy to Production Environment
        if: github.ref == 'refs/heads/production' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both'))
        run: |
          echo "üöÄ DEPLOYING TO PRODUCTION ENVIRONMENT"
          echo "======================================"
          
          # Install sshpass for automated deployment
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Get the latest deployment package
          DEPLOY_FILE=$(ls -t deployment-*.tar.gz | head -1)
          echo "üì¶ Deploying: $DEPLOY_FILE"
          
          # Prepare production server
          sshpass -p "Q23YP4MwsaPzD7" ssh -o StrictHostKeyChecking=no root@$PROD_HOST << 'EOF'
            # Install Node.js if not present
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            
            # Install PM2 if not present
            command -v pm2 >/dev/null 2>&1 || npm install -g pm2
            
            # Prepare deployment directories
            mkdir -p /var/www/bankim/{blue,green}
            
            # Determine current and new slots
            if [ -L /var/www/bankim/current ]; then
              CURRENT_SLOT=$(readlink /var/www/bankim/current | xargs basename)
            else
              CURRENT_SLOT="blue"
            fi
            
            NEW_SLOT=$([ "$CURRENT_SLOT" = "blue" ] && echo "green" || echo "blue")
            echo "Production - Current slot: $CURRENT_SLOT, Deploying to: $NEW_SLOT"
            
            # Clean new slot
            rm -rf /var/www/bankim/$NEW_SLOT/*
          EOF
          
          # Upload deployment package to production
          echo "üì§ Uploading to production server..."
          sshpass -p "Q23YP4MwsaPzD7" scp -o StrictHostKeyChecking=no $DEPLOY_FILE root@$PROD_HOST:/tmp/
          
          # Extract and deploy to production
          sshpass -p "Q23YP4MwsaPzD7" ssh -o StrictHostKeyChecking=no root@$PROD_HOST << EOF
            cd /tmp
            DEPLOY_FILE=\$(ls -t deployment-*.tar.gz | head -1)
            
            # Determine deployment slot
            if [ -L /var/www/bankim/current ]; then
              CURRENT_SLOT=\$(readlink /var/www/bankim/current | xargs basename)
            else
              CURRENT_SLOT="blue"
            fi
            NEW_SLOT=\$([ "\$CURRENT_SLOT" = "blue" ] && echo "green" || echo "blue")
            
            echo "Extracting to /var/www/bankim/\$NEW_SLOT"
            tar -xzf \$DEPLOY_FILE -C /var/www/bankim/\$NEW_SLOT
            
            # Install dependencies on server to ensure all modules are present
            echo "Installing dependencies on server..."
            cd /var/www/bankim/\$NEW_SLOT
            npm install || echo "Warning: npm install had issues"
            
            # Set permissions
            chown -R root:root /var/www/bankim/\$NEW_SLOT
            chmod -R 755 /var/www/bankim/\$NEW_SLOT
            
            # Configure web server proxy (if needed)
            if command -v nginx >/dev/null 2>&1; then
              echo "Configuring nginx proxy..."
              echo 'server {' > /etc/nginx/sites-available/bankim
              echo '    listen 80;' >> /etc/nginx/sites-available/bankim
              echo '    server_name dev2.bankimonline.com;' >> /etc/nginx/sites-available/bankim
              echo '    ' >> /etc/nginx/sites-available/bankim
              echo '    root /var/www/bankim/current/build;' >> /etc/nginx/sites-available/bankim
              echo '    index index.html;' >> /etc/nginx/sites-available/bankim
              echo '    ' >> /etc/nginx/sites-available/bankim
              echo '    location / {' >> /etc/nginx/sites-available/bankim
              echo '        try_files $uri $uri/ /index.html;' >> /etc/nginx/sites-available/bankim
              echo '    }' >> /etc/nginx/sites-available/bankim
              echo '    ' >> /etc/nginx/sites-available/bankim
              echo '    location /api {' >> /etc/nginx/sites-available/bankim
              echo '        proxy_pass http://localhost:8003;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_set_header Upgrade $http_upgrade;' >> /etc/nginx/sites-available/bankim
              echo "        proxy_set_header Connection 'upgrade';" >> /etc/nginx/sites-available/bankim
              echo '        proxy_set_header Host $host;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_set_header X-Real-IP $remote_addr;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> /etc/nginx/sites-available/bankim
              echo '        proxy_cache_bypass $http_upgrade;' >> /etc/nginx/sites-available/bankim
              echo '    }' >> /etc/nginx/sites-available/bankim
              echo '}' >> /etc/nginx/sites-available/bankim
              ln -sf /etc/nginx/sites-available/bankim /etc/nginx/sites-enabled/
              nginx -t && systemctl reload nginx || echo "Nginx config issue"
            fi
            
            # Switch to new deployment
            ln -sfn /var/www/bankim/\$NEW_SLOT /var/www/bankim/current
            
            # Start application
            cd /var/www/bankim/current
            pm2 delete bankim-api 2>/dev/null || echo "Process not running"
            pm2 start ecosystem.config.js --env production
            pm2 save
            pm2 startup || echo "PM2 startup already configured"
            
            echo "üöÄ Production deployment complete!"
            pm2 status
          EOF

      - name: Validate Production Deployment
        if: github.ref == 'refs/heads/production' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both'))
        run: |
          echo "üîç VALIDATING PRODUCTION DEPLOYMENT"
          echo "=================================="
          
          # Wait for services to stabilize
          echo "‚è≥ Waiting for services to start..."
          sleep 60
          
          # Test 1: NGINX is responding
          echo "Test 1: Checking NGINX..."
          if curl -f -I --max-time 10 "http://185.253.72.80" > /dev/null 2>&1; then
            echo "‚úÖ NGINX is responding"
          else
            echo "‚ö†Ô∏è NGINX not responding (check manually)"
          fi
          
          # Test 2: React app is served
          echo "Test 2: Checking React app..."
          if curl -f --max-time 10 "http://185.253.72.80" | grep -q '<div id="root">' > /dev/null 2>&1; then
            echo "‚úÖ React app is being served"
          else
            echo "‚ö†Ô∏è React app not loading (check manually)"
          fi
          
          # Test 3: API health check with retries
          echo "Test 3: Checking API health..."
          RETRY_COUNT=0
          MAX_RETRIES=3
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f --max-time 30 "http://185.253.72.80:8003/api/v1/health" > /dev/null 2>&1; then
              echo "‚úÖ Production API is responding"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Production API health check failed after $MAX_RETRIES attempts"
                echo "‚ö†Ô∏è Manual intervention may be required"
              else
                echo "‚ö†Ô∏è API not ready, retrying in 20 seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep 20
              fi
            fi
          done
          
          # Test 4: API proxy through NGINX
          echo "Test 4: Checking API proxy..."
          if curl -f --max-time 10 "http://185.253.72.80/api/v1/health" > /dev/null 2>&1; then
            echo "‚úÖ API proxy through NGINX is working"
          else
            echo "‚ö†Ô∏è API proxy not working (check manually)"
          fi
          
          echo "üéâ Production deployment completed!"
          echo "üåê Check: http://bankimonline.com"
          echo "üìä API: http://185.253.72.80:8003/api/v1/health"

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ CLEANUP"
          echo "=========="
          # Remove deployment files
          rm -f deployment-*.tar.gz
          rm -rf deploy/
          echo "‚úÖ Cleanup complete"

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã DEPLOYMENT SUMMARY"
          echo "===================="
          echo "üïê Time: $(date)"
          echo "üìç Branch: ${{ github.ref_name }}"
          echo "üî¢ Commit: ${{ github.sha }}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "üß™ Test: https://dev2.bankimonline.com (45.83.42.74:8003)"
          fi
          if [[ "${{ github.ref }}" == "refs/heads/production" ]]; then
            echo "üè¶ Production: https://bankimonline.com (185.253.72.80:8003)"
          fi
          echo "===================="